import{createAlert as t}from"alert";import{copyString as e}from"copy";import{getWrapper as a,postWrapper as n}from"fetch";import{$loading as r,$submitBtn as s,$loadingCard as d}from"loading";import{submitHandler as l,resetHandler as o}from"modals";export const $leaderboardDiv=document.getElementById("leaderboardDiv");const i=document.getElementById("trackStats"),c=document.getElementById("medalProgressDiv"),m=document.getElementById("statLineChart"),u={currStat:"xp",statLineChart:null},g="#0d6efd";let y={trackStats:!1};export async function getLeaderboard(t){return a({url:"/stats/leaderboard/stat/XP",$loadingDiv:t,loading:r,dataHandler:e=>{t.innerHTML=e}})}export function initStatsTracker(){i.addEventListener("click",async()=>{y.trackStats||(document.getElementById("trackStatsModal")||(y.trackStats=!0,await async function getTrackStats(){return a({url:"/stats/trackForm",$loadingDiv:null,loading:r,dataHandler:e=>{let a=document.createElement("div");a.innerHTML=e,document.getElementById("loadedModal").appendChild(a);const r=document.getElementById("trackStatsModal");globalModals.$trackStatsModal=new bootstrap.Modal(r,{});let d=document.getElementById("trackStatsForm"),i=document.getElementById("submitTrackStatsForm");i.addEventListener("click",async e=>{let a=d.checkValidity();if(d.classList.add("was-validated"),!a)return e.preventDefault(),void e.stopPropagation();l(r,i,!1);let c=new FormData(d),m=Object.fromEntries(c.entries());await async function submitTrackStats(e,a,r){return n({url:"/stats/track",$loadingBtn:a,loading:s,packet:JSON.stringify(e),responseType:"json",dataHandler:e=>{if(!e.success)throw t(document.getElementById("statAlert"),"danger","bi-exclamation-diamond-fill",""+e.message),o(r),Error(e.message);location.reload()}})}(m,i,r)})}})}()),globalModals.$trackStatsModal.show(),y.trackStats=!1)})}export async function getSummaryStats(t,e,a){e.innerHTML=d;let r={startDate:a.dataset.startdate,endDate:a.dataset.enddate,summary:!0};return n({url:"/overview/"+t,$loadingBtn:null,loading:"",packet:JSON.stringify(r),responseType:"text",dataHandler:t=>{e.innerHTML=t}})}export async function getPokedexStats(t,n){return a({url:"/stats/getPokedexStats/trainerid/"+t,$loadingDiv:n,loading:d,dataHandler:t=>{n.innerHTML=t;const a=document.getElementById("pokedexStatsCard");document.getElementById("copyMissingString").addEventListener("click",t=>{e([t.currentTarget],a.dataset.missingstring)}),document.getElementById("copyMissingShinyString").addEventListener("click",t=>{e([t.currentTarget],a.dataset.missingshinystring)})}})}export async function getMedalSummary(t,e){return a({url:"/stats/getMedalSummary/trainerid/"+t,$loadingDiv:e,loading:d,dataHandler:t=>{e.innerHTML=t}})}async function getMedalProgress(t){return a({url:"/stats/getMedalProgress",$loadingDiv:t,loading:r,dataHandler:e=>{t.innerHTML=e;let a=document.querySelectorAll(".medalInput");Array.from(a).forEach(t=>{t.addEventListener("blur",()=>{validateMedalInput(t)&&async function trackMedalProgress(t){t.disabled=!0;let e=t.parentElement.parentElement,a=e.dataset.id,r=t.value.trim();return n({url:"/stats/trackMedalProgress",$loadingBtn:null,loading:"",packet:JSON.stringify({medal:a,current:r}),responseType:"json",dataHandler:n=>{if(!n.success)throw Error(n.message);document.getElementById(a+"progressBar").style.width=100*r/e.dataset.platinum+"%";let s=document.getElementById(a+"icon");s&&(s.classList.remove("platinumMedal"),s.classList.remove("goldMedal"),s.classList.remove("silverMedal"),s.classList.remove("bronzeMedal"),r>=parseInt(e.dataset.platinum)?s.classList.add("platinumMedal"):r>=parseInt(e.dataset.gold)?s.classList.add("goldMedal"):r>=parseInt(e.dataset.silver)?s.classList.add("silverMedal"):r>=parseInt(e.dataset.bronze)&&s.classList.add("bronzeMedal")),t.disabled=!1}})}(t)}),t.addEventListener("input",()=>{validateMedalInput(t)})})}})}async function loadStatCards(){let t=[getLeaderboard($leaderboardDiv),getMedalProgress(c)];await Promise.all(t),function resizeStatCards(){new Masonry(".statCards",{itemSelector:".statCard",columnWidth:".col-xl-4"})}()}function changeStat(t){u.statLineChart&&u.statLineChart.destroy(),function renderChart(t,e){let a=statDataset.labels,n=[];for(let t=0;t<a.length;t++)n.push(statDataset.data[a[t]][e]);u.statLineChart=new Chart(t,{type:"line",data:{labels:a,datasets:[{label:e,data:n,fill:!1,borderColor:g,tension:.5}]}})}(m,t),document.getElementById(`delta${u.currStat}div`).classList.add("d-none"),document.getElementById(`delta${t}div`).classList.remove("d-none"),u.currStat=t}function validateMedalInput(t){let e=t.value.trim(),a=t.nextElementSibling;return 0!=e.length&&(isNaN(e)||!/^\d+$/.test(e)?(a.classList.add("showFeedback"),!1):(a.classList.remove("showFeedback"),!0))}export const runtime={all:()=>{},overview:()=>{changeStat(u.currStat),loadStatCards(),initStatsTracker(),Array.from(document.querySelectorAll(".changeStat")).forEach(t=>{t.addEventListener("click",t=>{let e=document.querySelector(".changeStat.active");e.classList.remove("active"),e.disabled=!1,changeStat(t.currentTarget.dataset.stat),t.currentTarget.classList.add("active"),t.currentTarget.disabled=!0})});let t=document.getElementById("startDate"),e=document.getElementById("endDate");const a="MM-DD-YYYY";$("#dateRangePicker").daterangepicker({startDate:t.value,endDate:e.value,opens:"center",alwaysShowCalendars:!0,ranges:{"This Week":[moment().startOf("week"),moment().endOf("week")],"Last Week":[moment().subtract(7,"days").startOf("week"),moment().subtract(7,"days").endOf("week")],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"This Year":[moment().startOf("year"),moment().endOf("year")],"Last Year":[moment().subtract(1,"year").startOf("year"),moment().subtract(1,"year").endOf("year")]}},function(n,r){t.value=n.format(a),e.value=r.format(a),document.getElementById("statsOverviewForm").submit()})}};