import{createAlert as e}from"alert";import{getWrapper as t,postWrapper as d}from"fetch";import{$loadingCard as n,$submitBtn as i}from"loading";import{submitHandler as r,resetHandler as a}from"modals";import{initStatsTracker as o,getSummaryStats as l,getPokedexStats as s,getMedalSummary as c}from"stats";import{createAddFriendSearch as m}from"search";const u=document.getElementById("friendsListDiv"),f=document.getElementById("medalSummaryDiv"),g=document.getElementById("friendRequestsDiv"),y=document.getElementById("pokedexStatsDiv"),p=document.getElementById("profilerow"),E=document.getElementById("summaryStatsDiv"),F=document.getElementById("mainProfileUsername").dataset.trainerid,M=document.getElementById("editProfile");let B={editProfile:!1,addFriend:!1};async function getFriendsToAdd(){return t({url:"/friend/getFriendsToAdd",$loadingDiv:null,loading:"",dataHandler:e=>{let t=document.createElement("div");t.innerHTML=e,document.getElementById("loadedModal").appendChild(t);const n=document.getElementById("addFriendModal");globalModals.$addFriendModal=new bootstrap.Modal(n,{}),m("friendsToAddSearch");let o=document.getElementById("addFriendForm"),l=document.getElementById("submitAddFriendForm");l.addEventListener("click",async e=>{let t=o.checkValidity();if(o.classList.add("was-validated"),!t)return e.preventDefault(),void e.stopPropagation();let s=l.innerHTML;r(n,l);let c=new FormData(o),m=Object.fromEntries(c.entries());await async function sendFriendRequest(e,t){return d({url:"/friend/sendFriendRequest",$loadingBtn:t,loading:i,packet:JSON.stringify(e),responseType:"json",dataHandler:e=>{if(!e.success)throw Error(e.message);loadFriendCards()}})}(m,l),a(n,l,s),globalModals.$addFriendModal.hide(),document.getElementById("addFriendModal").remove()})}})}async function getFriendsList(e){return t({url:"/friend/getFriendsList",$loadingDiv:e,loading:n,dataHandler:t=>{e.innerHTML=t,document.getElementById("addFriendBtn").addEventListener("click",async e=>{B.addFriend||(document.getElementById("addFriendModal")||(B.addFriend=!0,await getFriendsToAdd()),globalModals.$addFriendModal.show(),B.addFriend=!1)});let d=document.querySelectorAll(".trainerRow");Array.from(d).forEach(e=>{e.addEventListener("click",e=>{window.location.href=e.currentTarget.dataset.profilelink})})}})}async function getFriendRequests(e){return t({url:"/friend/getFriendRequests",$loadingDiv:e,loading:n,dataHandler:t=>{e.innerHTML=t;let n=document.querySelectorAll(".decideRequest");n&&Array.from(n).forEach(e=>{e.addEventListener("click",async e=>{let t=e.currentTarget,n={};n.friendrequestid=t.parentElement.dataset.friendrequestid,n.accept=t.dataset.accept,await async function decideFriendRequest(e,t){return d({url:"/friend/decideFriendRequest",$loadingBtn:t,loading:i,packet:JSON.stringify(e),responseType:"json",dataHandler:e=>{if(!e.success)throw Error(e.message);loadFriendCards()}})}(n,t)})})}})}async function getEditProfile(){return t({url:"/trainer/editProfile",$loadingDiv:null,loading:"",dataHandler:t=>{let n=document.createElement("div");n.innerHTML=t,document.getElementById("loadedModal").appendChild(n);const i=document.getElementById("editProfileModal");globalModals.$editProfileModal=new bootstrap.Modal(i,{});let o=document.getElementById("editProfileForm"),l=document.getElementById("submitEditProfileForm");l.addEventListener("click",async t=>{let n=o.checkValidity();if(o.classList.add("was-validated"),!n)return t.preventDefault(),void t.stopPropagation();let s=new FormData(o),c=Object.fromEntries(s.entries());await async function updateProfile(t,n,i){let o=n.innerHTML;return r(i,n),d({url:"/trainer/updateProfile",$loadingBtn:"",loading:"",packet:JSON.stringify(t),responseType:"json",dataHandler:d=>{a(i,n,o),d.success?(document.getElementById("profileUsername").innerHTML=t.username,document.getElementById("mainProfileUsername").innerHTML=t.username,document.getElementById("sidebarUsername").innerHTML=t.username,document.getElementById("profileEmail").innerHTML=t.email,document.getElementById("profileIcon").src=`/includes/images/icons/${t.icon}.webp`,document.getElementById("sidebarIcon").src=`/includes/images/icons/${t.icon}.webp`,globalModals.$editProfileModal.hide(),document.getElementById("editProfileModal").remove()):e(document.getElementById("editProfileAlertDiv"),"danger","bi-exclamation-diamond-fill",d.message,0)}})}(c,l,i)})}})}function resizeProfileCards(){new Masonry(".profileCards",{itemSelector:".profileCard"})}async function loadFriendCards(){await Promise.all([getFriendsList(u),getFriendRequests(g)]),resizeProfileCards()}export const runtime={all:()=>{},viewprofile:()=>{!async function loadProfileCards(){let e=[l(F,E,p),s(F,y),c(F,f)];"true"==p.dataset.myprofile&&(e.push(getFriendsList(u)),e.push(getFriendRequests(g)),o()),await Promise.all(e),resizeProfileCards()}(),M.addEventListener("click",async()=>{B.editProfile||(document.getElementById("editProfileModal")||(B.editProfile=!0,await getEditProfile()),globalModals.$editProfileModal.show(),B.editProfile=!1)})}};