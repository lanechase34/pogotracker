import{getCookie as e,setCookie as t}from"cookie";import{copyString as o}from"copy";import{postWrapper as n,getWrapper as d}from"fetch";import{$loading as i,$loadingModal as r}from"loading";import{confirmModal as a,submitHandler as s}from"modals";import{createMultiSelect as c}from"multiselect";import{createCustomSearch as l}from"search";const u=document.getElementById("pokedexTable"),m=document.getElementById("customPokedexTable"),g=document.getElementById("shadowPokedexTable"),h=document.getElementById("addCustomPokedex"),y=m?.dataset?.trainerid??-1,k=m?.dataset?.customid??-1,f=document.querySelectorAll("button.copySearchString"),p=document.querySelectorAll("button.copyMissingSearchString"),w=document.querySelectorAll("button.shinyToggle"),x=document.getElementById("monsRegistered"),E=document.querySelectorAll("button.pokedexLock"),v=document.querySelectorAll("button.registerAll"),L=u?.dataset?.trainerid??-1,P={count:0,counter:0,loadingList:!1},b={shiny:!1,mega:!1,shadow:!1,view:"",registered:0,total:0,lock:e("pokedexLock")??"false",mousedown:!1,catching:!1,active:""};let S={customEdit:!1,customAdd:!1};function submitCustomPokedexModal(e,t,o,d,i){let r=o.checkValidity();if(o.classList.add("was-validated"),!r)return e.preventDefault(),void e.stopPropagation();let a=new FormData(o),c=Object.fromEntries(a.entries()),l=a.getAll("pokemon[]");return c.pokemon=l,delete c["pokemon[]"],c.name.length&&c.pokemon.length?(s(i,d),c.public="public"in c&&"on"==c.public,Array.from(document.querySelectorAll(".closeCustomForm")).forEach(e=>{e.style.display="none"}),n({url:`/pokedex/${t}CustomPokedex`,$loadingBtn:null,loading:"",packet:JSON.stringify(c),responseType:"json",dataHandler:e=>{"delete"==t?window.location.reload():window.location="/mycustompokedex/"+e.data.id}})):void 0}async function getCustomPokedexModal(e,t){let o=`/pokedex/${e}Custompokedexform`;return t.length&&(o+="/customid/"+t),d({url:o,$loadingDiv:null,loading:"",dataHandler:t=>{let o=document.createElement("div");o.innerHTML=t,document.getElementById("loadedModal").appendChild(o);const n=document.getElementById("customPokedexModal");globalModals.$customPokedexModal=new bootstrap.Modal(n,{}),c(document.getElementById("pokemonList"),"Select Pokemon",100,!0);const d=document.getElementById("customPokedexForm"),i=document.getElementById("submitCustomForm");if(i.addEventListener("click",t=>{submitCustomPokedexModal(t,e,d,i,n)}),"edit"==e){const e=document.getElementById("deleteCustomForm");e.addEventListener("click",t=>{submitCustomPokedexModal(t,"delete",d,e,n)})}}})}function registerAllConfirm(){a(`This will register ALL ${b.shiny?"Shiny ":""}pokemon currently unregistered for the ${b.region} region. Proceed?`,'<i class="bi bi-arrow-right me-1"></i>Proceed',()=>{!async function registerAll(){return r.show(),n({url:"/pokedex/registerAll",$loadingBtn:null,loading:"",packet:JSON.stringify({region:b.region,shiny:b.shiny}),responseType:"json",dataHandler:()=>{location.href=`/mypokedex/region/${b.region}/shiny/${b.shiny}`}})}()})}function createEditEvent(e){let t=document.querySelectorAll(".editCustomPokedex"+e);Array.from(t).forEach(async e=>{e.addEventListener("click",async e=>{S.customEdit||(document.getElementById("customPokedexModal")&&document.getElementById("customPokedexModal").remove(),S.customEdit=!0,await getCustomPokedexModal("edit",e.currentTarget.dataset.customid),document.getElementById("customPokedexModal").addEventListener("hidden.bs.modal",()=>{document.getElementById("customPokedexModal").remove()}),globalModals.$customPokedexModal.show(),S.customEdit=!1)})})}async function fetchCustomPokedexList(e){let t=document.getElementById("nextGroup"+e);if(t)return d({url:"/pokedex/customPokedexList/offset/"+e,$loadingDiv:t,loading:i,dataHandler:async o=>{t.insertAdjacentHTML("afterend",o),t.remove(),createEditEvent(e),P.counter+=P.count,window.innerHeight>document.body.scrollHeight&&await fetchCustomPokedexList(P.counter)}})}async function switchCustomPokedex(){return d({url:`/pokedex/getCustomPokedex/trainerid/${y}/customid/${k}/shiny/${b.shiny}/hundo/false`,$loadingDiv:m,loading:i,dataHandler:e=>{m.innerHTML=e,b.view=document.querySelector("#pokedexGrid")?.dataset?.view??"none",createRegisterEvent(document.querySelectorAll("#pokedexGrid>.pokemonCell"));let t=document.getElementById("registeredCount").dataset;b.registered=t.registered,b.total=t.total,updateRegistered()}})}async function register(e){let t=e.currentTarget,o=t.dataset,d={pokemonid:o.id,caught:o.caught,shiny:o.shiny,hundo:o.hundo,shadow:o.shadow,shadowshiny:o.shadowshiny};return d[b.view]="true"!==d[b.view],o[b.view]=d[b.view],"true"===o[b.view]?(t.classList.add("caught"),b.registered++):(t.classList.remove("caught"),b.registered--),updateRegistered(),n({url:"/pokedex/register",$loadingBtn:null,loading:"",packet:JSON.stringify(d),responseType:"json",dataHandler:e=>{if(!e.success)throw Error(e.message)}}),d[b.view]}function createRegisterEvent(e){e.forEach(e=>{["mousedown","ontouchstart"].forEach(t=>{e.addEventListener(t,async e=>{e.preventDefault(),"false"==b.lock&&(b.mousedown=!0,b.catching=await register(e))})}),["mouseenter"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),"false"==b.lock&&b.mousedown&&b.catching==!e.currentTarget.classList.contains("caught")&&register(e)})})})}async function switchPokedex(e){Array.from(v).forEach(t=>{t.disabled="mega"==e||"giga"==e});let t=document.querySelector(".pokedex-link.active");t&&t.classList.remove("active"),document.querySelector(`.${e}link`).classList.add("active");let o="/pokedex/getPokedex";return e.length&&(o+="/region/"+e),L.length&&(o+="/trainerid/"+L),o+="/shiny/"+b.shiny,d({url:o,$loadingDiv:u,loading:i,dataHandler:e=>{u.innerHTML=e,b.view=document.querySelector("#pokedexGrid")?.dataset?.view??"none",createRegisterEvent(document.querySelectorAll("#pokedexGrid>.pokemonCell"));let t=document.getElementById("registeredCount").dataset;b.registered=t.registered,b.total=t.total,updateRegistered()}})}async function switchShadowPokedex(){let e="/pokedex/getPokedex";return L.length&&(e+="/trainerid/"+L),e+="/shiny/"+b.shiny,e+="/shadow/"+b.shadow,d({url:e,$loadingDiv:g,loading:i,dataHandler:e=>{g.innerHTML=e,b.view=document.querySelector("#pokedexGrid")?.dataset?.view??"none",createRegisterEvent(document.querySelectorAll("#pokedexGrid>.pokemonCell"));let t=document.getElementById("registeredCount").dataset;b.registered=t.registered,b.total=t.total,updateRegistered()}})}function updateRegistered(){x.innerHTML=`${b.registered} / ${b.total} Registered`;let e=b.registered/b.total;x.classList.remove("basic","bronze","silver","gold","diamond"),e<.25?x.classList.add("basic"):e<.5?x.classList.add("bronze"):e<.75?x.classList.add("silver"):e<1?x.classList.add("gold"):x.classList.add("diamond")}function copySearchString(e,t){let n="",d="";"region"in b&&(d+=b.region+"&"),"shadowshiny"==b.view?(t&&(n="[data-shadowshiny=false]"),d+="shadow&shiny&"):"shadow"==b.view?(t&&(n="[data-shadow=false]"),d+="shadow&"):"shiny"==b.view?(t&&(n="[data-shiny=false]"),d+="shiny&"):(t&&(n="[data-caught=false]"),d+=""),document.querySelectorAll("div.pokemonCell"+n).forEach(e=>{d+=e.dataset.number+","}),o(Array.from(e),d)}export const runtime={all:()=>{Array.from(f).forEach(e=>{e.addEventListener("click",()=>{copySearchString(f,!1)})}),Array.from(p).forEach(e=>{e.addEventListener("click",()=>{copySearchString(p,!0)})}),Array.from(E).forEach(e=>{e.addEventListener("click",()=>{!function toggleLock(){b.lock="true"==b.lock?"false":"true",t("pokedexLock",b.lock,100),Array.from(E).forEach(e=>{"true"==b.lock?e.innerHTML='<i class="bi bi-lock me-1"></i>Locked':e.innerHTML='<i class="bi bi-unlock me-1"></i>Unlocked'})}()})}),Array.from(w).forEach(e=>{e.addEventListener("click",async()=>{!async function toggleShiny(){b.shiny=!b.shiny,u?await switchPokedex(b.region):m?await switchCustomPokedex():g&&await switchShadowPokedex(),Array.from(w).forEach(e=>{b.shiny?(e.classList.remove("btn-danger"),e.classList.add("btn-success")):(e.classList.remove("btn-success"),e.classList.add("btn-danger"))})}()})}),Array.from(v).forEach(e=>{e.addEventListener("click",()=>{registerAllConfirm()})}),["mouseup","ontouchend"].forEach(e=>{document.addEventListener(e,e=>{e.preventDefault(),b.mousedown=!1,b.catching=!1})})},mypokedex:()=>{b.region=u.dataset.region,b.shiny="true"==u.dataset.shiny,switchPokedex(b.region),Array.from(document.querySelectorAll(".pokedex-link")).forEach(e=>{e.addEventListener("click",()=>{b.catching||b.mousedown||b.region==e.dataset.region||(b.region=e.dataset.region,switchPokedex(b.region))})})},mycustompokedex:()=>{b.shiny="true"==m.dataset.shiny,switchCustomPokedex()},custompokedexlist:()=>{h.addEventListener("click",async()=>{S.customAdd||(document.getElementById("customPokedexModal")||(S.customAdd=!0,await getCustomPokedexModal("add","")),globalModals.$customPokedexModal.show(),S.customAdd=!1)}),P.count=parseInt(document.getElementById("addCustomPokedex").dataset.count),createEditEvent(0),P.counter=P.count,window.innerHeight>document.getElementById("mainSection").offsetHeight&&fetchCustomPokedexList(P.counter),addEventListener("scroll",async()=>{window.innerHeight+window.scrollY>=document.body.scrollHeight&&!P.loadingList&&(P.loadingList=!0,await fetchCustomPokedexList(P.counter),P.loadingList=!1)}),l("customSearch","Search a Pokedex...",!0,"")},myshadowpokedex:()=>{b.shiny="true"==g.dataset.shiny,b.shadow=!0,switchShadowPokedex()}};